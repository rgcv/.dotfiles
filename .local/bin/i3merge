#!/bin/sh
set -eu

i3=${XDG_CONFIG_HOME-$HOME/.config}/i3
[ ! -d "$i3" ] && [ -d "$HOME/.i3" ] && i3=$HOME/.i3
mkdir -p "$i3"

i3config="$i3/config"
touch -a "$i3config" || exit $?
[ ! -w "$i3config" ] && i3-nagbar -m "Can't write config to '$i3'" && exit 1

confs="$i3/conf.d"
[ -d "$confs" ] || mkdir -p "$confs"
tmpconf="$i3config.$$"
{
  cat <<BANNER
#  _  _____                    __ _
# (_)|____ |                  / _(_)
#  _     / /   ___ ___  _ __ | |_ _  __ _
# | |    \ \  / __/ _ \| '_ \|  _| |/ _\` |
# | |.___/ / | (_| (_) | | | | | | | (_| |
# |_|\____/   \___\___/|_| |_|_| |_|\__, |
#                                    __/ |
#                                   |___/

################################################################################
# File automatically generated by '$0'.
#
# !!! WARNING !!! Please read the following advice/disclaimer:
#
# In order to alter the configuration, defer to individual configuration files
# stored in '$confs' and re-run this script.
#
# You have been warned!!! Further modifications made directly to this file is
# YOUR RESPONSIBILITY!!! If things break, it is YOUR fault.
################################################################################

BANNER

  # actual config: strips comments and unnecessary whitespace
  cat 2>&- "$i3/conf.d"/*.conf | awk '$0 !~ /^\s*(#|$)/ {$1=$1;print}'
} > "$tmpconf"
trap 'rm -f $tmpconf' EXIT TERM INT

if ! i3 -Cc "$tmpconf"; then
  i3-nagbar -m "Failed to validate resulting config"
  exit 1
fi
mv "$tmpconf" "$i3config"

if [ $# -gt 0 ]; then i3-msg -q "$@"; fi
