#!/bin/sh
# requires:
#   pactl (libpulse, set sink/source volume)
#   pacmd (pulseaudio, query sink/source status)
# uses:
#   canberra-gtk-play (libcanberra, play volume change sound
#                      libcanberra-pulse, pulseaudio backend may be required)
set -eu

app_name=${0##*/}
nid_file=/tmp/.$app_name.bin.nid

usage() {
  err=${1-0}
  [ "$err" -ne 0 ] && exec >&2
  cat<<EOF
Usage: $app_name [options] [-|+]<value>[%]
  -h, --help    Show this.

  -i, --input   Apply changes to input audio device.
  -i, --output  Apply changes to output audio device.

  -m, --mute    Mute device.
  -u, --unmute  Unmute device.
  -t, --toggle  Toggle device mute state.
EOF
  exit "$err"
}

# input parsing and validation
[ $# -gt 0 ] || usage 1

output=true
while [ $# -gt 0 ]; do
  case $1 in
    -h|--help) usage ;;

    --input)  output=false ;;
    --output) output=true  ;;

    -m|--mute)   mute=true   ;;
    -u|--unmute) mute=false  ;;
    -t|--toggle) mute=toggle ;;

    *) break ;;
  esac
  shift
done

$output && target=sink || target=source
TARGET=$(echo $target | tr '[:lower:]' '[:upper:]')

if [ $# -gt 0 ]; then
  t=${1#[-+]}
  case ${t%\%} in
    *[![:digit:]]*|'') usage 1 ;;
  esac

  pactl set-$target-volume "@DEFAULT_$TARGET@" "$1"
fi
[ -n "${mute-}" ] && pactl set-$target-mute "@DEFAULT_$TARGET@" $mute


# query values for notification
index=$(pacmd list-${target}s | grep -A0 '\* index:')
index=${index#*: }

data=$(pactl list ${target}s | grep -A9 "S${target#s} #$index")

description=$(echo "$data" | grep Description:)
description=${description#*: }

volume=$(echo "$data" | grep Volume: | grep -o '[[:digit:]]*%' | head -n 1)
volume=${volume%\%}

muted=$(echo "$data" | grep Mute:)
muted=${muted#*: }

icon=notification
if $output; then
  label="Output volume"
  icon=$icon-audio-volume
else
  label="Input sensitivity"
  icon=$icon-microphone-sensitivity
fi

case $muted in
  yes)
    volume=0
    summary="$label: muted"
    urgency=low
    icon=$icon-muted
    ;;
  *)
    summary="$label: $volume%"
    case $volume in
      0)
        urgency=low
        icon=$icon-muted
        ;;
      [1-9]|[1-3][0-9]) # 0 - 39
        urgency=low
        icon=$icon-low
        ;;
      [4-7][0-9]) # 40 - 79
        urgency=normal
        icon=$icon-medium
        ;;
      *) # >80
        urgency=critical
        icon=$icon-high
        ;;
    esac
    ;;
esac

pgrep -x pactl || pkill -RTMIN+25 i3blocks
notify-send.sh \
  --app-name "$app_name" \
  --urgency "$urgency" \
  --expire-time 3000 \
  --icon "$icon" \
  --hint int:value:"$volume" \
  --replace-file "$nid_file" \
  "$summary" "$description"

[ "$volume" -eq 0 ] || ! $output || canberra-gtk-play -i audio-volume-change &
