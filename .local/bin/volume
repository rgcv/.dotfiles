#!/bin/sh
# requires:
#   amixer (alsa-utils, volume management)
# uses:
#   canberra-gtk-play (libcanberra, play volume change sound
#                      libcanberra-pulse, pulseaudio backend may be required)
set -eu

app_name=${0##*/}
nid_file=/tmp/.$app_name.bin.nid
if [ -f "$nid_file" ]; then
  nid=$(cat "$nid_file")
else
  nid=-1
  echo "$nid" > "$nid_file"
fi

# audio mixer, sink control and capabilities
mixer=default
if amixer -D pulse info >/dev/null; then
  mixer=pulse
fi
scontrol=$(amixer -D "$mixer" scontrols |
  sed -n "s/Simple mixer control '\([^']*\)',0/\1/p" | head -n 1)
capability=$(amixer -D "$mixer" get "$scontrol" |
  sed -n "s/ Capabilities:.*cvolume.*/Capture/p")

# do some stuff
amixer -qMD "$mixer" sset "$scontrol" "$capability" "$@"
pgrep -x pactl || pkill -RTMIN+25 i3blocks

# display the notification
data=$(amixer -MD "$mixer" sget "$scontrol")
volume=$(echo "$data" | grep -o '[0-9]*%' | head -n 1)
  mute=$(echo "$data" | grep -o '\[off\]' | head -n 1)
  icon=notification-audio-volume

case $mute in
  '[off]')
    summary="Volume: Muted"
    urgency=low
    icon=$icon-muted
    ;;
  *)
    volume=${volume%\%}
    summary="Volume: $volume%"
    body=$(progress-string 20 '■ ' '□ ' "$volume")

    case "$volume" in
      0) # 0 (different from muted)
        urgency=low
        icon=$icon-off
        ;;
      [1-9]|[1-3][0-9]) # 0 - 39
        urgency=low
        icon=$icon-low
        ;;
      [4-7][0-9]) # 40 - 79
        urgency=normal
        icon=$icon-medium
        ;;
      *) # >80
        urgency=critical
        icon=$icon-high
        ;;
    esac
    ;;
esac

notify-send \
  --app-name "$app_name" \
  --urgency "$urgency" \
  --expire-time 3000 \
  --icon "$icon" \
  --replace "$nid" \
  --replace-file "$nid_file" \
  "$summary" "${body-}"

canberra-gtk-play -i audio-volume-change
